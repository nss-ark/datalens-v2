# =============================================================================
# DataLens 2.0 â€” Production Deployment
# =============================================================================
# Usage: docker compose -f docker-compose.prod.yml up -d
# Defines 3 separate backend instances (CC, Admin, Portal) + Nginx Gateway.
# =============================================================================

x-api-env: &api-env
  APP_ENV: production
  APP_LOG_LEVEL: info
  DB_HOST: postgres
  DB_PORT: 5432
  DB_USER: datalens
  DB_PASSWORD: ${DB_PASSWORD}
  DB_NAME: datalens
  REDIS_HOST: redis
  REDIS_PORT: 6379
  NATS_URL: nats://nats:4222
  CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}

services:
  # --- Reverse Proxy Gateway ---
  nginx:
    image: nginx:alpine
    container_name: datalens-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/nginx.conf:ro
      # Mount certificates here in real production:
      # - ./certs:/etc/nginx/certs:ro
    depends_on:
      - api-cc
      - api-admin
      - api-portal
    restart: always

  # --- Backend: Control Centre ---
  api-cc:
    build: .
    container_name: datalens-api-cc
    command: [ "/app/api", "--mode=cc", "--port=8080" ]
    expose:
      - "8080"
    environment:
      <<: *api-env
      APP_PORT: 8080
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
      nats:
        condition: service_started
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8080/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: always

  # --- Backend: Admin Panel ---
  api-admin:
    build: .
    container_name: datalens-api-admin
    command: [ "/app/api", "--mode=admin", "--port=8081" ]
    expose:
      - "8081"
    environment:
      <<: *api-env
      APP_PORT: 8081
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8081/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: always

  # --- Backend: Data Principal Portal ---
  api-portal:
    build: .
    container_name: datalens-api-portal
    command: [ "/app/api", "--mode=portal", "--port=8082" ]
    expose:
      - "8082"
    environment:
      <<: *api-env
      APP_PORT: 8082
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost:8082/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
    restart: always

  # --- Infrastructure Services ---
  postgres:
    image: postgres:16-alpine
    container_name: datalens-postgres-prod
    environment:
      POSTGRES_DB: datalens
      POSTGRES_USER: datalens
      POSTGRES_PASSWORD: ${DB_PASSWORD}
    volumes:
      - postgres_data_prod:/var/lib/postgresql/data
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U datalens" ]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always

  redis:
    image: redis:7-alpine
    container_name: datalens-redis-prod
    volumes:
      - redis_data_prod:/data
    restart: always

  nats:
    image: nats:2-alpine
    container_name: datalens-nats-prod
    command: [ "--jetstream", "--store_dir", "/data" ]
    volumes:
      - nats_data_prod:/data
    restart: always

volumes:
  postgres_data_prod:
  redis_data_prod:
  nats_data_prod:
