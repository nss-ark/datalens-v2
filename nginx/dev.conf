# =============================================================================
# DataLens 2.0 — Local Development Reverse Proxy
# =============================================================================
# Routes sub-domains to the correct backend mode and frontend app.
# Development URLs:
#   cc.localhost:8000       → Control Centre frontend (:3000)
#   admin.localhost:8000    → Admin frontend (:3001)
#   portal.localhost:8000   → Portal frontend (:3002)
#   api.localhost:8000      → Backend API (all mode, :8080)
# =============================================================================

worker_processes 1;
error_log /var/log/nginx/error.log warn;
events {
    worker_connections 256;
}

http {
    # --- Upstream definitions ---
    upstream cc_frontend   { server host.docker.internal:3000; }
    upstream admin_frontend { server host.docker.internal:3001; }
    upstream portal_frontend { server host.docker.internal:3002; }
    upstream api_backend   { server host.docker.internal:8080; }

    # --- Control Centre ---
    server {
        listen 8000;
        server_name cc.localhost;

        location /api/ {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://cc_frontend;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # --- Admin ---
    server {
        listen 8000;
        server_name admin.localhost;

        location /api/ {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://admin_frontend;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # --- Portal ---
    server {
        listen 8000;
        server_name portal.localhost;

        location /api/ {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location / {
            proxy_pass http://portal_frontend;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }

    # --- API Direct Access ---
    server {
        listen 8000;
        server_name api.localhost;

        location / {
            proxy_pass http://api_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }

    # --- Default (catch-all) → CC ---
    server {
        listen 8000 default_server;
        server_name _;

        location / {
            proxy_pass http://cc_frontend;
            proxy_set_header Host $host;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }
    }
}
